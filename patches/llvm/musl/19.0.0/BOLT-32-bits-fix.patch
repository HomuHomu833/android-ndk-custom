diff --git a/bolt/include/bolt/Core/DebugData.h b/bolt/include/bolt/Core/DebugData.h
index 7d10b208d..3f8874d81 100644
--- a/bolt/include/bolt/Core/DebugData.h
+++ b/bolt/include/bolt/Core/DebugData.h
@@ -147,22 +147,41 @@ struct DebugLineTableRowRef {
     return !(*this == Rhs);
   }
 
+#if UINTPTR_MAX < 0xFFFFFFFFFFFFFFFF
+  static std::vector<DebugLineTableRowRef>& getDebugRowStorage() {
+    static std::vector<DebugLineTableRowRef> Storage;
+    return Storage;
+  }
+#endif
+
   static DebugLineTableRowRef fromSMLoc(const SMLoc &Loc) {
+#if UINTPTR_MAX < 0xFFFFFFFFFFFFFFFF
+    auto index = reinterpret_cast<uintptr_t>(Loc.getPointer());
+    return getDebugRowStorage().at(index);
+#else
     union {
       decltype(Loc.getPointer()) Ptr;
       DebugLineTableRowRef Ref;
     } U;
     U.Ptr = Loc.getPointer();
     return U.Ref;
+#endif
   }
 
   SMLoc toSMLoc() const {
+#if UINTPTR_MAX < 0xFFFFFFFFFFFFFFFF
+    auto &storage = getDebugRowStorage();
+    storage.push_back(*this);
+    uintptr_t index = storage.size() - 1;
+    return SMLoc::getFromPointer(reinterpret_cast<const char *>(index));
+#else
     union {
       decltype(SMLoc().getPointer()) Ptr;
       DebugLineTableRowRef Ref;
     } U;
     U.Ref = *this;
     return SMLoc::getFromPointer(U.Ptr);
+#endif
   }
 };
 
